<% presenter = LendingItemViewPresenter.new(self, @lending_item, @lending_item_loan) %>

<% content_for(:page_title, "#{@lending_item.title}") %>
<h1>UC BEARS (UC Berkeley Electronic and Accessible Reserves System)</h1>

<section class="item">
  <% if presenter.show_viewer? %>
    <%
      # TODO: something less hacky
      content_for(:head_additional) do
        next unless @lending_item_loan&.active?

        redirect_s = 5 + @lending_item_loan.seconds_remaining.to_i
        redirect_url = lending_return_url(directory: @lending_item_loan.lending_item.directory)
    %>
      <meta http-equiv="Refresh" content="<%= "#{redirect_s}; URL=#{redirect_url}" %>">
      <%= javascript_pack_tag('viewer') %>
      <%= stylesheet_link_tag('viewer') %>
    <% end %>

    <%=
      render(
        partial: 'viewer',
        locals: {
          manifest_url: manifest_url,
          viewer_title: presenter.viewer_title,
        }
      )
    %>
  <% else %>
    <h2><%= presenter.title %></h2>
  <% end %>

  <table class="item-metadata">
    <% presenter.fields.each do |label, value| %>
      <tr>
        <th><%= label %></th>
        <td><%= format_value(value) %></td>
      </tr>
    <% end %>
    <%# TODO: something less hacky %>
    <% if presenter.loan.ok_to_check_out? %>
      <tr>
        <td class="copyright">
          <h3>⚠️ Warning of Copyright</h3>
          <p>
            The copyright law of the United States (Title 17, United States Code) governs the making of photocopies
            or other reproductions of copyrighted material. Under certain conditions specified in the law, libraries
            and archives are authorized to furnish a photocopy or other reproduction. One of these specific conditions
            is that the photocopy or reproduction is not to be “used for any purpose other than private study,
            scholarship, or research.” The library has utilized technical measures to prevent any further copying,
            downloading, or distribution of this work. Use of this reproduction in violation of these terms could
            subject users to potential liability for copyright infringement.
          </p>
        </td>
      </tr>
      <tr>
        <th class="action" style="grid-column: 1 / 3"><%# TODO: something less hacky %>
          <%= presenter.action %>
        </th>
      </tr>
    <% elsif !presenter.loan.active? %>
      <tr>
        <td class="copyright">
          <h2>⚠️ Item not available</h2>
          <p><%= presenter.loan.reason_unavailable %></p>
          <% other_checkouts = presenter.loan.other_checkouts.to_a %>
          <% unless other_checkouts.empty? %>
            <p>Items currently checked out:</p>
            <ul style="padding-left: 1rem; list-style-type: square;"><%# TODO: style this properly %>
              <% other_checkouts.each do |other_loan| %>
                <%
                  other_item = other_loan.lending_item
                  view_url = lending_view_url(directory: other_item.directory, token: presenter.borrower_token_str)
                %>
                <li>
                  <%= link_to(other_item.title, view_url, target: '_blank') %>
                </li>
              <% end %>
            </ul>
          <% end %>
        </td>
      </tr>
      <tr>
        <th class="action" style="grid-column: 1 / 3"><%# TODO: something less hacky %>
          <%= presenter.action %>
        </th>
      </tr>
    <% else %>
      <tr>
        <th class="action">
          <%= presenter.action %>
        </th>
      </tr>
    <% end %>

  </table>
</section>
